<html>

<head>
    <title>HK OZP Tool - GeoJSON Polygons</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: sans-serif;
        }

        #map-area {
            width: 100%;
            height: 100%;
        }

        .esri-attribution a {
            color: black;
        }

        .esri-attribution {
            background-color: transparent;
            font-size: 12px;
            font-family: sans-serif;
            color: black;
        }

        .esri-attribution__powered-by {
            display: none;
        }

        .copyright-url {
            position: absolute;
            bottom: 5px;
            right: 40px;
            padding: 0 4px;
            font-family: sans-serif;
            font-size: 12px;
        }

        .copyright-logo {
            position: absolute;
            bottom: 5px;
            right: 10px;
            width: 28px;
            height: 28px;
            display: inline-flex;
            background-size: 28px;
        }
        
        /* Layer list panel */
        .layer-list-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            max-width: 250px;
            max-height: 70%;
            overflow-y: auto;
            z-index: 50;
        }
        
        .layer-item {
            margin: 5px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        /* Loading indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <script src="https://js.arcgis.com/4.29/"></script>
    <div id="map-area"></div>
    
    <!-- Loading indicator -->
    <div class="loading-indicator" id="loading-indicator">
        Loading GeoJSON data...
    </div>
    
    <!-- Layer list panel -->
    <div class="layer-list-panel">
        <h3 style="margin-top: 0;">Layers</h3>
        <div class="layer-item">
            <input type="checkbox" id="geojson-polygons-toggle" checked>
            <label for="geojson-polygons-toggle">GeoJSON Polygons</label>
        </div>
        
        <h4>Zone Legend</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(255, 0, 0, 0.5);"></div>
            <div>C - Commercial</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(0, 255, 0, 0.5);"></div>
            <div>G/IC - Government/Institution</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(128, 0, 128, 0.5);"></div>
            <div>MRDJ - Marine Related Development Jurisdiction</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(255, 165, 0, 0.5);"></div>
            <div>O - Open Space</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(255, 215, 0, 0.5);"></div>
            <div>OU - Other Specified Uses</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(0, 0, 255, 0.5);"></div>
            <div>R(A) - Residential (Group A)</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(0, 191, 255, 0.5);"></div>
            <div>R(B) - Residential (Group B)</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(128, 128, 128, 0.5);"></div>
            <div>Other Zones</div>
        </div>
    </div>
    
    <script>
        require([
            "esri/Map", "esri/Basemap", "esri/layers/VectorTileLayer",
            "esri/views/MapView", "esri/geometry/SpatialReference",
            "esri/geometry/Point", "esri/Graphic", "esri/layers/GraphicsLayer",
            "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
            "esri/Color"
        ], function (Map, Basemap, VectorTileLayer, MapView, SpatialReference, Point, Graphic, GraphicsLayer, 
                    SimpleFillSymbol, SimpleLineSymbol, Color) {
            const basemapVTURL = "https://mapapi.geodata.gov.hk/gs/api/v1.0.0/vt/basemap/HK80";
            const mapLabelVTUrl = "https://mapapi.geodata.gov.hk/gs/api/v1.0.0/vt/label/hk/en/HK80";

            const basemap = new Basemap({
                baseLayers: [
                    new VectorTileLayer({
                        url: basemapVTURL,
                        copyright: '<a href="https://api.portal.hkmapservice.gov.hk/disclaimer" target="_blank" class="copyright-url">&copy; Map information from Lands Department</a><div class="copyright-logo" ></div>'
                    })
                ]
            });

            // Create graphics layer for GeoJSON polygons
            const geojsonPolygonsLayer = new GraphicsLayer();
            
            const map = new Map({
                basemap: basemap,
                layers: [geojsonPolygonsLayer] // Add the graphics layer to the map
            });

            const mView = new MapView({
                container: "map-area",
                map: map,
                zoom: 14,
                center: new Point(114.170515, 22.304, new SpatialReference({ wkid: 4326 })),
            });

            // Load and display GeoJSON polygons from the provided URL
            const geojsonUrl = 'https://raw.githubusercontent.com/KU1311/HK_OZP_Tool/main/S_K1_29_merged.geojson';
            
            fetch(geojsonUrl)
                .then(response => response.json())
                .then(geojsonData => {
                    // Hide loading indicator
                    document.getElementById('loading-indicator').style.display = 'none';
                    
                    // Process each feature in the GeoJSON
                    geojsonData.features.forEach(feature => {
                        // Create polygon from coordinates
                        const polygon = {
                            type: "polygon",
                            rings: feature.geometry.coordinates[0].map(coord => [coord[0], coord[1]]),
                            spatialReference: { wkid: 4326 }
                        };
                        
                        // Determine color based on zone type
                        let fillColor;
                        switch(feature.properties.ZONE_LABEL) {
                            case "C":
                                fillColor = new Color([255, 0, 0, 0.5]); // Red
                                break;
                            case "G/IC":
                                fillColor = new Color([0, 255, 0, 0.5]); // Green
                                break;
                            case "MRDJ":
                                fillColor = new Color([128, 0, 128, 0.5]); // Purple
                                break;
                            case "O":
                                fillColor = new Color([255, 165, 0, 0.5]); // Orange
                                break;
                            case "OU":
                                fillColor = new Color([255, 215, 0, 0.5]); // Gold
                                break;
                            case "R(A)":
                                fillColor = new Color([0, 0, 255, 0.5]); // Blue
                                break;
                            case "R(B)":
                                fillColor = new Color([0, 191, 255, 0.5]); // Deep Sky Blue
                                break;
                            default:
                                fillColor = new Color([128, 128, 128, 0.5]); // Gray
                        }
                        
                        // Create symbol for the polygon
                        const symbol = new SimpleFillSymbol({
                            color: fillColor,
                            outline: new SimpleLineSymbol({
                                color: new Color([0, 0, 0, 0.7]),
                                width: 1
                            })
                        });
                        
                        // Create attributes without functions to avoid serialization issues
                        const attributes = {
                            ZONE_LABEL: feature.properties.ZONE_LABEL,
                            DESC_ENG: feature.properties.DESC_ENG,
                            PLAN_NO: feature.properties.PLAN_NO,
                            SPUSE_ENG: feature.properties.SPUSE_ENG,
                            Shape_Area: feature.properties.Shape_Area,
                            BHC_TYPE: feature.properties.BHC_TYPE,
                            BHC_VALUE: feature.properties.BHC_VALUE
                        };
                        
                        // Create graphic for the polygon
                        const graphic = new Graphic({
                            geometry: polygon,
                            symbol: symbol,
                            attributes: attributes,
                            popupTemplate: {
                                title: "{ZONE_LABEL} - {DESC_ENG}",
                                content: `
                                    <b>Plan No:</b> {PLAN_NO}<br>
                                    <b>Zone Label:</b> {ZONE_LABEL}<br>
                                    <b>Description:</b> {DESC_ENG}<br>
                                    <b>Special Use:</b> {SPUSE_ENG}<br>
                                    <b>Area:</b> {Shape_Area} sq units<br>
                                    <b>BHC Type:</b> {BHC_TYPE}<br>
                                    <b>BHC Value:</b> {BHC_VALUE}
                                `
                            }
                        });
                        
                        // Add the graphic to the GeoJSON polygons layer
                        geojsonPolygonsLayer.add(graphic);
                    });
                    
                    // Set up layer toggle
                    document.getElementById('geojson-polygons-toggle').addEventListener('change', function(e) {
                        geojsonPolygonsLayer.visible = e.target.checked;
                    });
                })
                .catch(error => {
                    console.error('Error loading GeoJSON:', error);
                    document.getElementById('loading-indicator').innerHTML = 'Error loading GeoJSON data';
                });

            // Add label layer after map view is created
            mView.when(() => {
                map.add(new VectorTileLayer(mapLabelVTUrl));
            });
        });
    </script>
</body>

</html>
