<!DOCTYPE html>
<html>

<head>
    <title>HK OZP Tool - GeoJSON Polygons</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: sans-serif;
        }

        #map-area {
            width: 100%;
            height: 100%;
        }

        .esri-attribution a {
            color: black;
        }

        .esri-attribution {
            background-color: transparent;
            font-size: 12px;
            font-family: sans-serif;
            color: black;
        }

        .esri-attribution__powered-by {
            display: none;
        }

        .copyright-url {
            position: absolute;
            bottom: 5px;
            right: 40px;
            padding: 0 4px;
            font-family: sans-serif;
            font-size: 12px;
        }

        .copyright-logo {
            position: absolute;
            bottom: 5px;
            right: 10px;
            width: 28px;
            height: 28px;
            display: inline-flex;
            background-size: 28px;
        }

        /* Layer list panel */
        .layer-list-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            max-width: 250px;
            max-height: 70%;
            overflow-y: auto;
            z-index: 50;
        }

        .layer-item {
            margin: 5px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        /* Loading indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <script src="https://js.arcgis.com/4.29/"></script>
    <div id="map-area"></div>

    <div class="loading-indicator" id="loading-indicator">
        Loading GeoJSON data...
    </div>

    <div class="layer-list-panel">
        <h3 style="margin-top: 0;">Layers</h3>
        <div class="layer-item">
            <input type="checkbox" id="geojson-polygons-toggle" checked>
            <label for="geojson-polygons-toggle">GeoJSON Polygons</label>
        </div>

        <h4>Zone Legend</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(255, 0, 0, 0.5);"></div>
            <div>C - Commercial</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(0, 255, 0, 0.5);"></div>
            <div>G/IC - Government/Institution</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(128, 0, 128, 0.5);"></div>
            <div>MRDJ - Marine Related Development Jurisdiction</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(255, 165, 0, 0.5);"></div>
            <div>O - Open Space</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(255, 215, 0, 0.5);"></div>
            <div>OU - Other Specified Uses</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(0, 0, 255, 0.5);"></div>
            <div>R(A) - Residential (Group A)</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(0, 191, 255, 0.5);"></div>
            <div>R(B) - Residential (Group B)</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(128, 128, 128, 0.5);"></div>
            <div>Other Zones</div>
        </div>
    </div>

    <script>
        require([
            "esri/Map", "esri/Basemap", "esri/layers/VectorTileLayer",
            "esri/views/MapView", "esri/geometry/SpatialReference",
            "esri/geometry/Point", "esri/Graphic", "esri/layers/GraphicsLayer",
            "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
            "esri/Color", "esri/geometry/projection"
        ], function (Map, Basemap, VectorTileLayer, MapView, SpatialReference, Point, Graphic, GraphicsLayer,
            SimpleFillSymbol, SimpleLineSymbol, Color, projection) {

            const basemapVTURL = "https://mapapi.geodata.gov.hk/gs/api/v1.0.0/vt/basemap/WGS84";
            const mapLabelVTUrl = "https://mapapi.geodata.gov.hk/gs/api/v1.0.0/vt/label/hk/en/WGS84";

            const basemap = new Basemap({
                baseLayers: [
                    new VectorTileLayer({
                        url: basemapVTURL,
                        copyright: '<a href="https://api.portal.hkmapservice.gov.hk/disclaimer" target="_blank" class="copyright-url">&copy; Map information from Lands Department</a><div class="copyright-logo" ></div>'
                    })
                ]
            });

            const geojsonPolygonsLayer = new GraphicsLayer();

            const map = new Map({
                basemap: basemap,
                layers: [geojsonPolygonsLayer]
            });

            const mView = new MapView({
                container: "map-area",
                map: map,
                zoom: 14,
                center: new Point(114.170515, 22.304, new SpatialReference({ wkid: 4326 })),
            });
            
            // Wait for the view to be ready, then trigger the load process
            mView.when(() => {
                console.log("MapView is ready. Loading GeoJSON data...");
                
                // Add label layer
                map.add(new VectorTileLayer(mapLabelVTUrl));

                // Explicitly load projection module (in case needed, though we're aligning to WGS84)
                projection.load().then(() => {
                    console.log("Projection loaded.");
                }).catch(err => {
                    console.error("Error loading projection:", err);
                });

                const geojsonUrl = 'https://raw.githubusercontent.com/KU1311/HK_OZP_Tool/main/S_K1_29_merged.geojson';

                fetch(geojsonUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(geojsonData => {
                        console.log("GeoJSON data loaded successfully.");
                        document.getElementById('loading-indicator').style.display = 'none';

                        if (!geojsonData.features || geojsonData.features.length === 0) {
                            console.warn("GeoJSON file contains no features or is empty.");
                            return;
                        }

                        let graphics = [];

                        geojsonData.features.forEach(feature => {
                            if (!feature.geometry) return;

                            const type = feature.geometry.type;

                            let fillColor;
                            switch (feature.properties.ZONE_LABEL) {
                                case "C":
                                    fillColor = new Color([255, 0, 0, 0.5]);
                                    break;
                                case "G/IC":
                                    fillColor = new Color([0, 255, 0, 0.5]);
                                    break;
                                case "MRDJ":
                                    fillColor = new Color([128, 0, 128, 0.5]);
                                    break;
                                case "O":
                                    fillColor = new Color([255, 165, 0, 0.5]);
                                    break;
                                case "OU":
                                    fillColor = new Color([255, 215, 0, 0.5]);
                                    break;
                                case "R(A)":
                                    fillColor = new Color([0, 0, 255, 0.5]);
                                    break;
                                case "R(B)":
                                    fillColor = new Color([0, 191, 255, 0.5]);
                                    break;
                                default:
                                    fillColor = new Color([128, 128, 128, 0.5]);
                            }

                            const symbol = new SimpleFillSymbol({
                                color: fillColor,
                                outline: new SimpleLineSymbol({
                                    color: new Color([0, 0, 0, 0.7]),
                                    width: 1
                                })
                            });

                            const attributes = {
                                ZONE_LABEL: feature.properties.ZONE_LABEL,
                                DESC_ENG: feature.properties.DESC_ENG,
                                PLAN_NO: feature.properties.PLAN_NO,
                                SPUSE_ENG: feature.properties.SPUSE_ENG,
                                Shape_Area: feature.properties.Shape_Area,
                                BHC_TYPE: feature.properties.BHC_TYPE,
                                BHC_VALUE: feature.properties.BHC_VALUE
                            };

                            const popupTemplate = {
                                title: "{ZONE_LABEL} - {DESC_ENG}",
                                content: `
                                    <b>Plan No:</b> {PLAN_NO}<br>
                                    <b>Zone Label:</b> {ZONE_LABEL}<br>
                                    <b>Description:</b> {DESC_ENG}<br>
                                    <b>Special Use:</b> {SPUSE_ENG}<br>
                                    <b>Area:</b> {Shape_Area} sq units<br>
                                    <b>BHC Type:</b> {BHC_TYPE}<br>
                                    <b>BHC Value:</b> {BHC_VALUE}
                                `
                            };

                            let polygonGeometries = [];
                            if (type === "Polygon") {
                                polygonGeometries = [feature.geometry.coordinates];
                            } else if (type === "MultiPolygon") {
                                polygonGeometries = feature.geometry.coordinates;
                            } else {
                                return;
                            }

                            polygonGeometries.forEach(rings => {
                                const polygon = {
                                    type: "polygon",
                                    rings: rings,
                                    spatialReference: { wkid: 4326 }
                                };

                                const graphic = new Graphic({
                                    geometry: polygon,
                                    symbol: symbol,
                                    attributes: attributes,
                                    popupTemplate: popupTemplate
                                });

                                graphics.push(graphic);
                            });
                        });
                        
                        const validGraphics = graphics.filter(g => g !== undefined);
                        geojsonPolygonsLayer.addMany(validGraphics);
                        console.log(`${validGraphics.length} graphics added to the layer.`);

                        // Force a redraw by toggling visibility
                        geojsonPolygonsLayer.visible = false;
                        setTimeout(() => {
                            geojsonPolygonsLayer.visible = true;
                        }, 10);

                        // Force a redraw by going to the extent
                        if (validGraphics.length > 0) {
                            mView.goTo(validGraphics).then(() => {
                                console.log("Map zoomed to the extent of the polygons. They should now be visible.");
                            }).catch(err => {
                                console.error("Error zooming to extent:", err);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading GeoJSON:', error);
                        document.getElementById('loading-indicator').innerHTML = 'Error loading GeoJSON data';
                    });
                
                document.getElementById('geojson-polygons-toggle').addEventListener('change', function (e) {
                    geojsonPolygonsLayer.visible = e.target.checked;
                });
            });
        });
    </script>
</body>

</html>
